{% extends "base.html" %}
{% block content %}
  <h1>Modo Sessão</h1>

  <p class="muted">
    Use códigos ou apelidos. Evite dados pessoais identificáveis e registre apenas o mínimo necessário.
  </p>

  <p class="muted" style="font-size:13px;">
    Orientação: registre principalmente <strong>suas intervenções e condutas clínicas</strong>, de acordo com a sua abordagem,
    sem detalhar a história do caso. Priorize o que sustenta continuidade do processo (hipóteses, foco, combinados e encaminhamentos).
  </p>

  <div class="grid2">
    <div class="card">
      <h2>Registro de sessão</h2>
      <p class="muted" style="margin-top:-6px;">
        Um único registro por sessão, com data automática. Foque na sua prática clínica, não na narrativa detalhada do caso.
      </p>

      <form method="post" action="/modo-sessao/add">
        <!-- Mantém compatibilidade com o backend (sem mostrar pré/durante/pós) -->
        <input type="hidden" name="stage" value="during">

        <label>Paciente (código ou apelido)</label>
        <input name="patient_alias" placeholder="Ex.: P01, CasoTCC, AcompanhamentoA">

        <label>Conteúdo (mínimo necessário)</label>
        <textarea id="sessionContent" name="content" rows="12" required
          placeholder="Utilize o modelo sugerido ou escreva livremente, mantendo o mínimo necessário."></textarea>

        <div class="row" style="margin-top:10px;">
          <button type="button" class="btn" onclick="insertTemplate()">Inserir modelo de registro</button>
          <button type="submit">Salvar registro</button>
        </div>
      </form>

      <hr>

      <h2>Filtro</h2>
      <form method="get" action="/modo-sessao">
        <label>Filtrar por paciente/código</label>
        <select name="patient">
          <option value="" {% if not selected_patient %}selected{% endif %}>Todos</option>
          {% for p in patients %}
            <option value="{{ p }}" {% if selected_patient == p %}selected{% endif %}>{{ p }}</option>
          {% endfor %}
        </select>
        <button type="submit">Filtrar</button>
      </form>
    </div>

    <div class="card">
      <h2>Registros recentes</h2>

      {% if notes|length == 0 %}
        <p class="muted">Sem registros ainda.</p>
      {% else %}

        {# Agrupamento por paciente/código #}
        {% for group in notes|groupby('patient_alias') %}
          <div class="item">
            <div class="itemhead">
              <strong>
                Paciente: {% if group.grouper %}{{ group.grouper }}{% else %}Sem código{% endif %}
              </strong>
            </div>

            {% for n in group.list %}
              <div class="item" style="border-top:none;">
                <div class="itemhead">
                  <strong>Registro</strong>
                  <span class="muted">{{ n.created_at.strftime("%d/%m/%Y %H:%M") }}</span>
                </div>

                <pre class="pre">{{ n.content }}</pre>

                <details class="subform">
                  <summary><strong>Editar</strong></summary>

                  <form method="post" action="/modo-sessao/update">
                    <input type="hidden" name="note_id" value="{{ n.id }}">

                    <!-- Mantém compatibilidade com o backend (sem mostrar pré/durante/pós) -->
                    <input type="hidden" name="stage" value="during">

                    <label>Paciente (código ou apelido)</label>
                    <input name="patient_alias" value="{{ n.patient_alias }}">

                    <label>Conteúdo (mínimo necessário)</label>
                    <textarea name="content" rows="10" required>{{ n.content }}</textarea>

                    <button type="submit">Salvar alterações</button>
                  </form>
                </details>

                <form method="post" action="/modo-sessao/delete" onsubmit="return confirm('Apagar este registro?');">
                  <input type="hidden" name="note_id" value="{{ n.id }}">
                  <button class="danger" type="submit">Apagar</button>
                </form>
              </div>
            {% endfor %}
          </div>
        {% endfor %}

      {% endif %}
    </div>
  </div>

  <script>
    function insertTemplate() {
      const textarea = document.getElementById("sessionContent");
      if (!textarea) return;

      if (textarea.value.trim() !== "") {
        const ok = confirm("Deseja substituir o conteúdo atual pelo modelo sugerido?");
        if (!ok) return;
      }

      textarea.value =
`Data: (automática)

Foco da sessão (1 linha):
- 

Intervenções realizadas (conforme sua abordagem):
- 

Combinados/limites do setting:
- 

Encaminhamentos / próximos passos:
- 

Observação ética:
- Registro mínimo necessário, sem dados identificáveis ou narrativa detalhada do caso.`;
    }
  </script>
{% endblock %}
