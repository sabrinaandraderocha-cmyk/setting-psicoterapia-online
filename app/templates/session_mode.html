{% extends "base.html" %}
{% block content %}
  <h1>Modo Sessão</h1>

  <p class="muted">
    Use códigos ou apelidos. Evite dados pessoais identificáveis e registre apenas o mínimo necessário.
  </p>

  <p class="muted" style="font-size:13px;">
    Orientação: registre principalmente <strong>suas intervenções e condutas clínicas</strong>, de acordo com a sua abordagem,
    sem detalhar a história do caso. Priorize o que sustenta continuidade do processo (foco, intervenções, combinados e encaminhamentos).
  </p>

  <p class="muted" style="font-size:13px;">
    Registro orientado pela abordagem: utilize este espaço para anotar suas
    <strong>intervenções, decisões clínicas e encaminhamentos</strong>, conforme sua abordagem teórica,
    evitando dados identificáveis. Se desejar, você pode <strong>baixar o registro em .txt</strong>
    e armazená-lo localmente.
  </p>

  <div class="grid2">
    <div class="card">
      <h2>Registro de sessão</h2>
      <p class="muted" style="margin-top:-6px;">
        Um único registro por sessão, com data automática. Foque na sua prática clínica, não na narrativa detalhada do caso.
      </p>

      <form method="post" action="/modo-sessao/add">
        <!-- Mantém compatibilidade com o backend (sem mostrar pré/durante/pós) -->
        <input type="hidden" name="stage" value="during">

        <label>Paciente (código ou apelido)</label>
        <input name="patient_alias" placeholder="Ex.: P01, CasoTCC, AcompanhamentoA">

        <label>Conteúdo (mínimo necessário)</label>
        <textarea id="sessionContent" name="content" rows="12" required
          placeholder="Escolha um modelo sugerido ou escreva livremente (mínimo necessário)."></textarea>

        <div class="row" style="margin-top:10px;">
          <button type="button" class="btn" onclick="insertTemplateHumanista()">Modelo humanista</button>
          <button type="button" class="btn" onclick="insertTemplateTCC()">Modelo TCC</button>
          <button type="button" class="btn" onclick="insertTemplatePsicanalise()">Modelo psicanálise</button>

          <button type="button" class="btn" onclick="downloadTxt()">Baixar .txt</button>

          <button type="submit">Salvar registro</button>
        </div>
      </form>

      <p class="muted" style="font-size:12px; margin-top:8px;">
        Dica: modelos servem como guia. Ajuste os campos conforme sua abordagem e o contexto do atendimento.
      </p>

      <hr>

      <h2>Filtro</h2>
      <form method="get" action="/modo-sessao">
        <label>Filtrar por paciente/código</label>
        <select name="patient">
          <option value="" {% if not selected_patient %}selected{% endif %}>Todos</option>
          {% for p in patients %}
            <option value="{{ p }}" {% if selected_patient == p %}selected{% endif %}>{{ p }}</option>
          {% endfor %}
        </select>
        <button type="submit">Filtrar</button>
      </form>
    </div>

    <div class="card">
      <h2>Registros recentes</h2>

      {% if notes|length == 0 %}
        <p class="muted">Sem registros ainda.</p>
      {% else %}

        {# Agrupamento por paciente/código #}
        {% for group in notes|groupby('patient_alias') %}
          <div class="item">
            <div class="itemhead">
              <strong>
                Paciente: {% if group.grouper %}{{ group.grouper }}{% else %}Sem código{% endif %}
              </strong>
            </div>

            {% for n in group.list %}
              <div class="item" style="border-top:none;">
                <div class="itemhead">
                  <strong>Registro</strong>
                  <span class="muted">{{ n.created_at.strftime("%d/%m/%Y %H:%M") }}</span>
                </div>

                <pre class="pre">{{ n.content }}</pre>

                <details class="subform">
                  <summary><strong>Editar</strong></summary>

                  <form method="post" action="/modo-sessao/update">
                    <input type="hidden" name="note_id" value="{{ n.id }}">

                    <!-- Mantém compatibilidade com o backend -->
                    <input type="hidden" name="stage" value="during">

                    <label>Paciente (código ou apelido)</label>
                    <input name="patient_alias" value="{{ n.patient_alias }}">

                    <label>Conteúdo (mínimo necessário)</label>
                    <textarea name="content" rows="12" required>{{ n.content }}</textarea>

                    <button type="submit">Salvar alterações</button>
                  </form>
                </details>

                <form method="post" action="/modo-sessao/delete" onsubmit="return confirm('Apagar este registro?');">
                  <input type="hidden" name="note_id" value="{{ n.id }}">
                  <button class="danger" type="submit">Apagar</button>
                </form>
              </div>
            {% endfor %}
          </div>
        {% endfor %}

      {% endif %}
    </div>
  </div>

  <script>
    function confirmReplaceIfNeeded(textarea) {
      if (textarea.value.trim() !== "") {
        return confirm("Deseja substituir o conteúdo atual pelo modelo sugerido?");
      }
      return true;
    }

    function insertTemplateHumanista() {
      const textarea = document.getElementById("sessionContent");
      if (!textarea) return;
      if (!confirmReplaceIfNeeded(textarea)) return;

      textarea.value =
`Data: (automática)

Foco vivido / tema emergente (experiência):
- 

Vivência e campo (o que se apresentou na relação e no contexto):
- 

Intervenções do(a) terapeuta (congruentes com a abordagem):
- Presença / escuta / devolução
- Clarificação de experiência e sentidos
- Facilitação de simbolização (quando aplicável)
- Ajuste de limites e cuidado com o setting

Combinados e limites (setting digital / entre sessões):
- 

Continuidade (próximos passos / encaminhamentos):
- 

Observação ética:
- Mínimo necessário, sem dados identificáveis e sem narrativa detalhada do caso.`;
    }

    function insertTemplateTCC() {
      const textarea = document.getElementById("sessionContent");
      if (!textarea) return;
      if (!confirmReplaceIfNeeded(textarea)) return;

      textarea.value =
`Data: (automática)

Agenda / foco da sessão:
- 

Situação-alvo (descrição mínima, sem identificação):
- 

Cognições-chave (pensamentos automáticos / crenças relevantes):
- 

Emoções e intensidade (0–10):
- 

Comportamentos / estratégias atuais:
- 

Intervenções do(a) terapeuta (TCC):
- Psicoeducação (se aplicável)
- Questionamento socrático / reestruturação
- Técnicas comportamentais (exposição, ativação, etc.)
- Treino de habilidades (se aplicável)

Tarefa de casa / plano entre sessões:
- 

Combinados e limites do setting:
- 

Observação ética:
- Registro mínimo necessário, sem dados identificáveis e sem narrativa detalhada do caso.`;
    }

    function insertTemplatePsicanalise() {
      const textarea = document.getElementById("sessionContent");
      if (!textarea) return;
      if (!confirmReplaceIfNeeded(textarea)) return;

      textarea.value =
`Data: (automática)

Tema dominante / material emergente (sem detalhes identificáveis):
- 

Associações e elementos recorrentes:
- 

Afetos mobilizados e variações:
- 

Movimentos transferenciais / contratransferenciais (quando pertinente):
- 

Intervenções do(a) analista:
- Manejo do enquadre / setting
- Pontuações / interpretações (se aplicável)
- Silêncios, cortes, devoluções

Combinados e limites do setting:
- 

Indicações de continuidade (próximos passos / encaminhamentos):
- 

Observação ética:
- Mínimo necessário, sem dados identificáveis e sem narrativa detalhada do caso.`;
    }

    function downloadTxt() {
      const textarea = document.getElementById("sessionContent");
      if (!textarea || !textarea.value.trim()) {
        alert("Não há conteúdo para baixar.");
        return;
      }

      const blob = new Blob([textarea.value], { type: "text/plain;charset=utf-8" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;

      const now = new Date();
      const yyyy = now.getFullYear();
      const mm = String(now.getMonth() + 1).padStart(2, "0");
      const dd = String(now.getDate()).padStart(2, "0");

      a.download = `registro_sessao_${yyyy}-${mm}-${dd}.txt`;

      document.body.appendChild(a);
      a.click();

      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
  </script>
{% endblock %}
