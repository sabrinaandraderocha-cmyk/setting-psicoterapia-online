{% extends "base.html" %}
{% block content %}
  <h1>Modo Sessão</h1>

  <p class="muted">
    Use códigos ou apelidos. Evite dados pessoais identificáveis e registre apenas o mínimo necessário.
  </p>

  <p class="muted" style="font-size:13px;">
    Este espaço é um <strong>gerador de registro mínimo</strong> orientado pela sua abordagem.
    O Setting <strong>não armazena</strong> registros de sessão neste módulo e <strong>não substitui prontuário clínico</strong>.
    Se desejar, você pode <strong>copiar</strong> o texto ou <strong>baixar em .txt</strong> e arquivar localmente sob sua responsabilidade.
  </p>

  <div class="grid2">
    <div class="card">
      <h2>Registro mínimo (não armazenável)</h2>
      <p class="muted" style="margin-top:-6px;">
        Foque nas <strong>suas intervenções e decisões clínicas</strong> (conforme sua abordagem), sem detalhar a história do caso.
      </p>

      <label>Paciente (código ou apelido)</label>
      <input id="patientAlias" placeholder="Ex.: P01, CasoTCC, AcompanhamentoA">

      <label>Conteúdo (mínimo necessário)</label>
      <textarea id="sessionContent" rows="14" required
        placeholder="Escolha um modelo sugerido ou escreva livremente (mínimo necessário)."></textarea>

      <div class="row" style="margin-top:10px;">
        <button type="button" class="btn" onclick="insertTemplateHumanista()">Modelo humanista</button>
        <button type="button" class="btn" onclick="insertTemplateTCC()">Modelo TCC</button>
        <button type="button" class="btn" onclick="insertTemplatePsicanalise()">Modelo psicanálise</button>
      </div>

      <div class="row" style="margin-top:10px;">
        <button type="button" class="btn" onclick="copyText()">Copiar</button>
        <button type="button" class="btn" onclick="downloadTxt()">Baixar .txt</button>
        <button type="button" class="btn" onclick="clearText()">Limpar</button>
      </div>

      <p class="muted" style="font-size:12px; margin-top:10px;">
        Dica: modelos são guias. Ajuste os campos conforme sua abordagem e o contexto do atendimento.
      </p>

      <hr>

      <p class="muted" style="font-size:12px;">
        Nota ética: evite dados identificáveis e não registre conteúdo sensível desnecessário.
        Priorize intervenções, combinados e próximos passos.
      </p>
    </div>

    <div class="card tip">
      <h2>Como usar (fluxo recomendado)</h2>
      <ol style="margin:0; padding-left:18px;">
        <li>Escolha um modelo (Humanista, TCC ou Psicanálise).</li>
        <li>Edite apenas o essencial do ponto de vista do profissional.</li>
        <li>Copie ou baixe o texto em <strong>.txt</strong> para arquivar localmente.</li>
      </ol>
      <p class="muted" style="font-size:12px; margin-top:10px;">
        Este módulo não mantém histórico no sistema. O arquivamento é de responsabilidade do(a) profissional,
        conforme seus critérios e as normativas aplicáveis.
      </p>
    </div>
  </div>

  <script>
    function confirmReplaceIfNeeded(textarea) {
      if (textarea.value.trim() !== "") {
        return confirm("Deseja substituir o conteúdo atual pelo modelo sugerido?");
      }
      return true;
    }

    function insertTemplateHumanista() {
      const textarea = document.getElementById("sessionContent");
      if (!textarea) return;
      if (!confirmReplaceIfNeeded(textarea)) return;

      textarea.value = `MODELO (NÃO ARMAZENÁVEL) — ABORDAGEM HUMANISTA

Foco vivido / tema emergente (experiência):
- 

Vivência e campo (o que se apresentou na relação e no contexto):
- 

Intervenções do(a) terapeuta (congruentes com a abordagem):
- Presença / escuta / devolução
- Clarificação de experiência e sentidos
- Facilitação de simbolização (quando aplicável)
- Ajuste de limites e cuidado com o setting

Combinados e limites (setting digital / entre sessões):
- 

Continuidade (próximos passos / encaminhamentos):
- 

Observação ética:
- Mínimo necessário, sem dados identificáveis e sem narrativa detalhada do caso.`;
      textarea.focus();
    }

    function insertTemplateTCC() {
      const textarea = document.getElementById("sessionContent");
      if (!textarea) return;
      if (!confirmReplaceIfNeeded(textarea)) return;

      textarea.value = `MODELO (NÃO ARMAZENÁVEL) — TCC

Agenda / foco da sessão:
- 

Situação-alvo (descrição mínima, sem identificação):
- 

Cognições-chave (pensamentos automáticos / crenças relevantes):
- 

Emoções e intensidade (0–10):
- 

Comportamentos / estratégias atuais:
- 

Intervenções do(a) terapeuta (TCC):
- Psicoeducação (se aplicável)
- Questionamento socrático / reestruturação
- Técnicas comportamentais (exposição, ativação, etc.)
- Treino de habilidades (se aplicável)

Plano entre sessões:
- 

Combinados e limites do setting:
- 

Observação ética:
- Registro mínimo necessário, sem dados identificáveis e sem narrativa detalhada do caso.`;
      textarea.focus();
    }

    function insertTemplatePsicanalise() {
      const textarea = document.getElementById("sessionContent");
      if (!textarea) return;
      if (!confirmReplaceIfNeeded(textarea)) return;

      textarea.value = `MODELO (NÃO ARMAZENÁVEL) — PSICANÁLISE

Tema dominante / material emergente (sem detalhes identificáveis):
- 

Associações e elementos recorrentes:
- 

Afetos mobilizados e variações:
- 

Movimentos transferenciais / contratransferenciais (quando pertinente):
- 

Intervenções do(a) analista:
- Manejo do enquadre / setting
- Pontuações / interpretações (se aplicável)
- Silêncios, cortes, devoluções

Combinados e limites do setting:
- 

Indicações de continuidade (próximos passos / encaminhamentos):
- 

Observação ética:
- Mínimo necessário, sem dados identificáveis e sem narrativa detalhada do caso.`;
      textarea.focus();
    }

    async function copyText() {
      const textarea = document.getElementById("sessionContent");
      if (!textarea || !textarea.value.trim()) {
        alert("Não há conteúdo para copiar.");
        return;
      }

      const text = textarea.value;

      // Preferir API moderna
      try {
        if (navigator.clipboard && window.isSecureContext) {
          await navigator.clipboard.writeText(text);
          alert("Texto copiado.");
          return;
        }
      } catch (e) {
        // cai no fallback
      }

      // Fallback antigo
      textarea.select();
      textarea.setSelectionRange(0, 999999);
      document.execCommand("copy");
      alert("Texto copiado.");
    }

    function clearText() {
      const textarea = document.getElementById("sessionContent");
      if (!textarea) return;
      if (textarea.value.trim() && !confirm("Limpar o texto atual?")) return;
      textarea.value = "";
      textarea.focus();
    }

    function downloadTxt() {
      const textarea = document.getElementById("sessionContent");
      const aliasInput = document.getElementById("patientAlias");

      const content = textarea ? textarea.value.trim() : "";
      if (!content) {
        alert("Não há conteúdo para baixar.");
        return;
      }

      const now = new Date();
      const yyyy = now.getFullYear();
      const mm = String(now.getMonth() + 1).padStart(2, "0");
      const dd = String(now.getDate()).padStart(2, "0");
      const hh = String(now.getHours()).padStart(2, "0");
      const min = String(now.getMinutes()).padStart(2, "0");

      const aliasRaw = aliasInput ? aliasInput.value.trim() : "";
      const aliasSafe = aliasRaw ? aliasRaw.replace(/[^a-zA-Z0-9_-]/g, "_").slice(0, 40) : "sem_codigo";

      const header =
`SETTING — MODO SESSÃO (NÃO ARMAZENÁVEL)
Data/hora: ${dd}/${mm}/${yyyy} ${hh}:${min}
Paciente/código: ${aliasRaw || "—"}

-------------------------
`;

      const fullText = header + content + "\n";
      const blob = new Blob([fullText], { type: "text/plain;charset=utf-8" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = `registro_${aliasSafe}_${yyyy}-${mm}-${dd}.txt`;

      document.body.appendChild(a);
      a.click();

      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
  </script>
{% endblock %}
