{% extends "base.html" %}
{% block content %}

<div class="card tip" style="margin-bottom:14px;">
  <h2>Gerar PDF (modelo)</h2>
  <p class="muted">Gera um PDF de modelo (declaração/atestado) para você revisar e usar no Word/Docs, se desejar.</p>

  <form method="post" action="/documentos/gerar-documento-pdf" target="_blank">
    <label>Tipo</label>
    <select name="tipo">
      <option value="declaracao">Declaração de comparecimento (modelo)</option>
      <option value="atestado">Atestado (modelo)</option>
    </select>

    <label>Paciente (nome/apelido)</label>
    <input name="paciente" placeholder="ex.: Paciente X (ou apelido)">

    <label>Profissional</label>
    <input name="profissional" placeholder="Seu nome">

    <label>CRP</label>
    <input name="crp" placeholder="00/00000">

    <label>Cidade/UF</label>
    <input name="cidade_uf" placeholder="ex.: Uberlândia/MG">

    <label>Data de emissão</label>
    <input name="data_emissao" placeholder="dd/mm/aaaa">

    <button type="submit">Gerar PDF</button>
  </form>
</div>

<h1>Documentos (modelos)</h1>
<p class="muted">Edite modelos e gere uma versão preenchida. Você pode copiar o texto gerado e colar no Word/Docs.</p>

<div class="grid2">

  <!-- Coluna esquerda: criação + variáveis -->
  <div class="card">
    <h2>Criar novo modelo</h2>

    <form method="post" action="/documentos/add">
      <label>Nome</label>
      <input name="name" required>

      <label>Corpo</label>
      <textarea name="body" rows="10"
        placeholder="Use variáveis: {% raw %}{{PROFISSIONAL_NOME}}, {{CRP}}, {{PACIENTE_NOME}}, {{DATA}}{% endraw %} ..."></textarea>

      <button type="submit">Criar</button>
    </form>

    <div class="card tip" style="margin-top:12px;">
      <h3>Variáveis suportadas</h3>
      <div class="tag">{% raw %}{{PROFISSIONAL_NOME}}{% endraw %}</div>
      <div class="tag">{% raw %}{{CRP}}{% endraw %}</div>
      <div class="tag">{% raw %}{{PACIENTE_NOME}}{% endraw %}</div>
      <div class="tag">{% raw %}{{DATA}}{% endraw %}</div>
      <div class="tag">{% raw %}{{TOLERANCIA_MIN}}{% endraw %}</div>
      <div class="tag">{% raw %}{{PAGAMENTO_REGRAS}}{% endraw %}</div>
      <div class="tag">{% raw %}{{REAGENDAMENTO_REGRAS}}{% endraw %}</div>
      <div class="tag">{% raw %}{{JANELA_CONTATO}}{% endraw %}</div>
    </div>
  </div>

  <!-- Coluna direita: lista de modelos -->
  <div class="card">
    <h2>Modelos</h2>

    {% if docs and (docs|length > 0) %}
      <div class="muted" style="margin:8px 0 12px;">
        Dica: use <strong>Gerar texto</strong> para abrir o formulário de preenchimento.
        Use <strong>Abrir/Editar</strong> para ajustar o corpo do modelo.
      </div>

      <!-- Modelos base -->
      <div class="card tip" style="margin-bottom:12px;">
        <div class="row" style="justify-content:space-between; align-items:center;">
          <h3 style="margin:0;">Modelos CFP (base)</h3>
          <div class="tag">recomendados</div>
        </div>
        <p class="muted" style="margin:8px 0 0; font-size:12px;">
          Modelos iniciais para uso profissional. Você pode editar e adaptar conforme sua prática, respeitando o sigilo e o mínimo necessário.
        </p>
      </div>

      {% set found_base = false %}
      {% for d in docs %}
        {% set n = (d.name or '')|lower %}
        {% if ('atestado' in n) or ('declara' in n) or ('consent' in n) or ('combinad' in n) %}
          {% set found_base = true %}
          <div class="item">
            <div class="itemhead">
              <strong>{{ d.name }}</strong>
              <span class="muted">
                {% if d.created_at %}{{ d.created_at.strftime("%d/%m/%Y") }}{% else %}-{% endif %}
              </span>
            </div>

            <div class="row" style="margin-top:8px; gap:10px;">
              <button type="button" class="btn" onclick="toggleEdit('{{ d.id }}')">Abrir/Editar</button>
              <button type="button" class="btn" onclick="toggleRender('{{ d.id }}')">Gerar texto</button>
              <span class="tag">base</span>

              <form method="post" action="/documentos/delete" onsubmit="return confirm('Apagar este modelo?');">
                <input type="hidden" name="doc_id" value="{{ d.id }}">
                <button class="danger" type="submit">Apagar</button>
              </form>
            </div>

            <div id="edit-{{ d.id }}" style="display:none; margin-top:10px;">
              <form method="post" action="/documentos/update" class="subform">
                <input type="hidden" name="doc_id" value="{{ d.id }}">
                <label>Nome</label>
                <input name="name" value="{{ d.name }}" required>
                <label>Corpo</label>
                <textarea name="body" rows="12">{{ d.body }}</textarea>
                <button type="submit">Salvar alterações</button>
              </form>
            </div>

            <div id="render-{{ d.id }}" style="display:none; margin-top:10px;">
              <form method="post" action="/documentos/render" target="_blank" class="subform">
                <input type="hidden" name="doc_id" value="{{ d.id }}">

                <label>Profissional</label>
                <input name="profissional_nome" placeholder="Seu nome">

                <label>CRP</label>
                <input name="crp" placeholder="00/00000">

                <label>Paciente</label>
                <input name="paciente_nome" placeholder="Nome (se for usar)">

                <label>Data</label>
                <input name="data" placeholder="dd/mm/aaaa">

                <label>Tolerância (min)</label>
                <input name="tolerancia_min" value="10">

                <label>Regras de pagamento</label>
                <input name="pagamento_regras" placeholder="ex.: Pix até 24h antes">

                <label>Reagendamento/cancelamento</label>
                <input name="reagendamento_regras" placeholder="ex.: até 24h antes">

                <label>Janela de contato entre sessões</label>
                <input name="janela_contato" placeholder="ex.: seg-sex 9h-18h (nao emergencias)">

                <button type="submit">Gerar texto preenchido</button>
              </form>
            </div>
          </div>
        {% endif %}
      {% endfor %}

      {% if not found_base %}
        <p class="muted">Sem modelos base identificados.</p>
      {% endif %}

      <hr>

      <!-- Meus modelos -->
      <div class="card" style="margin-bottom:12px;">
        <div class="row" style="justify-content:space-between; align-items:center;">
          <h3 style="margin:0;">Meus modelos</h3>
          <div class="tag">personalizados</div>
        </div>
        <p class="muted" style="margin:8px 0 0; font-size:12px;">
          Modelos criados/ajustados por você para sua prática.
        </p>
      </div>

      {% set found_user = false %}
      {% for d in docs %}
        {% set n = (d.name or '')|lower %}
        {% if not (('atestado' in n) or ('declara' in n) or ('consent' in n) or ('combinad' in n)) %}
          {% set found_user = true %}
          <div class="item">
            <div class="itemhead">
              <strong>{{ d.name }}</strong>
              <span class="muted">
                {% if d.created_at %}{{ d.created_at.strftime("%d/%m/%Y") }}{% else %}-{% endif %}
              </span>
            </div>

            <div class="row" style="margin-top:8px; gap:10px;">
              <button type="button" class="btn" onclick="toggleEdit('{{ d.id }}')">Abrir/Editar</button>
              <button type="button" class="btn" onclick="toggleRender('{{ d.id }}')">Gerar texto</button>

              <form method="post" action="/documentos/delete" onsubmit="return confirm('Apagar este modelo?');">
                <input type="hidden" name="doc_id" value="{{ d.id }}">
                <button class="danger" type="submit">Apagar</button>
              </form>
            </div>

            <div id="edit-{{ d.id }}" style="display:none; margin-top:10px;">
              <form method="post" action="/documentos/update" class="subform">
                <input type="hidden" name="doc_id" value="{{ d.id }}">
                <label>Nome</label>
                <input name="name" value="{{ d.name }}" required>
                <label>Corpo</label>
                <textarea name="body" rows="12">{{ d.body }}</textarea>
                <button type="submit">Salvar alterações</button>
              </form>
            </div>

            <div id="render-{{ d.id }}" style="display:none; margin-top:10px;">
              <form method="post" action="/documentos/render" target="_blank" class="subform">
                <input type="hidden" name="doc_id" value="{{ d.id }}">

                <label>Profissional</label>
                <input name="profissional_nome" placeholder="Seu nome">

                <label>CRP</label>
                <input name="crp" placeholder="00/00000">

                <label>Paciente</label>
                <input name="paciente_nome" placeholder="Nome (se for usar)">

                <label>Data</label>
                <input name="data" placeholder="dd/mm/aaaa">

                <label>Tolerância (min)</label>
                <input name="tolerancia_min" value="10">

                <label>Regras de pagamento</label>
                <input name="pagamento_regras" placeholder="ex.: Pix até 24h antes">

                <label>Reagendamento/cancelamento</label>
                <input name="reagendamento_regras" placeholder="ex.: até 24h antes">

                <label>Janela de contato entre sessões</label>
                <input name="janela_contato" placeholder="ex.: seg-sex 9h-18h (nao emergencias)">

                <button type="submit">Gerar texto preenchido</button>
              </form>
            </div>
          </div>
        {% endif %}
      {% endfor %}

      {% if not found_user %}
        <p class="muted">Você ainda não criou modelos personalizados.</p>
      {% endif %}

      <script>
        function toggleEdit(id) {
          const el = document.getElementById('edit-' + id);
          if (!el) return;
          el.style.display = (el.style.display === 'none' || el.style.display === '') ? 'block' : 'none';
        }

        function toggleRender(id) {
          const el = document.getElementById('render-' + id);
          if (!el) return;
          el.style.display = (el.style.display === 'none' || el.style.display === '') ? 'block' : 'none';
        }
      </script>

    {% else %}
      <p class="muted">Sem modelos ainda.</p>
    {% endif %}
  </div>

</div>

{% endblock %}
